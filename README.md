# Семплирование ответов поставщиков

#### Почему?
* Чем больше поставщиков, чем сложнее ретестировать и проверять возможные кейсы
  и ответы поставщиков. 
* У нас в среднем есть эталонное поведение в проде, чтобы ловить регресс фич, 
  которые затрагивают все интеграции разом 
  и конкретно по каким-то определённым. 

#### Идея
* Семлировать 1% ответов поставщиков как поисков, так и бронирований.
* Записывать их результаты (подумать об удачных и неудачных случаях).
* В последующем использовать этот трафик и результаты, как эталон при работе 
  с новым кодом, генерируя эти же запросы или добавляя поверх этих записей 
  необходимые нам тест-кейсы.

#### Чем это лучше нежели другие виды тестирования?
* Ручное тестирование будет занимать слишком много времени с увеличением 
  количества интеграций и разработчиков, которые этим занимаются.
* С простой автоматизацией есть в проблемы с тем, что работа поставщиков
  недетерминированна и тестироваться будет скорее случайность, 
  нежели известное поведение.
* Кроме того, поддержка таких кейсов в актуальном состоянии данных потребует 
  времени замены старых данных новых.
* Мы получаем smoke-тестирование с постоянным вытеснением старых данных, 
  если это необходимо, новыми данными и известным результатом.

#### Алгоритм
Так сейчас во всех поисковых интеграциях произошёл переход 
на абстрактный слой работы с внешними поставщиками, то:
* Случайным образом в 1% случаев в поисковой сессии используется такой клиент
  общения, который умеет записывать входящие параметры поиска, тело ответа 
  поставщика(в асинхронном режиме, чтобы не замедлить поиск), и добавлять 
  эту информацию в хранилище с ключом, зависящим от параметров поиска.
* В последующем, в тестовом режиме этот же клиент работы с внешними ресурсами 
  поставщиков, использует хранилище как источник ответов поставщиков, 
  а внешняя система тестирования сравнивает результаты работы с теми данными, 
  которые были записаны в прод окружении. 
* Кроме того, на основе этих данных можно написать проверочные кейсы, 
  которых не было в прод окружении, проверяя другие аспекты — скорость работы, 
  стабильность и аналогичные, не бизнес показатели.
* Такой же подход можно будет в будущем использовать для бронирований, 
  чтобы проверять работу в неудачных случаях или случаях со сложной логикой. 

#### Примечения 
* Так как нам нужно эмулировать поведение API поставщика, 
  с использованием данных из хранилища ответов, то можно основываться 
  на файле конфигурации rproxy - в нём сейчас есть знания, 
  какой поставщик, какой корневой URL использует для ответов Островку, 
  соответственно мы можем использовать его, 
  как источник для автоматического создания всех нужных API endpoint-ов.
* В последующем мы можем так же использовать эти данные в близких 
  к suppdlierd/go-booker сервисах для аналогичных сценариев 
  тестирования - hotcore/ccproxy/ostrota.
